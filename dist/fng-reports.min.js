/*! forms-angular 2015-12-04 */
"use strict";function ngGridCsvExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.init=function(c,d,e){function f(){var a=angular.element("h1").parent(),c=angular.element("#csv-data-link");null!=c&&c.remove();var d='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';d+=encodeURIComponent(b.prepareCSV()),d+='" download="Export.csv">CSV Export</button>',a.append(d)}b.grid=d,b.scope=c,a.inhibitButton||(setTimeout(f,0),c.catHashKeys=function(){var a="";for(var b in c.renderedRows)a+=c.renderedRows[b].$$hashKey;return a},c.$watch("catHashKeys()",f))},b.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(b.prepareCSV()))},b.prepareCSV=function(){function a(a){return null==a?"":"number"==typeof a?""+a:"boolean"==typeof a?a?"TRUE":"FALSE":"string"==typeof a?a.replace(/"/g,'""'):JSON.stringify(a).replace(/"/g,'""')}function c(a){var b=a.substr(0,a.length-1);return b+"\n"}var d="";return angular.forEach(b.scope.columns,function(b){b.visible&&(void 0===b.width||b.width>0)&&(d+='"'+a(b.displayName)+'",')}),d=c(d),angular.forEach(b.grid.filteredRows,function(e){angular.forEach(b.scope.columns,function(b){b.visible&&(d+='"'+a(e.entity[b.field])+'",')}),d=c(d)}),d}}function ngGridPdfExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.services=null,b.options=a,b.init=function(c,d,e){if(b.grid=d,b.scope=c,b.services=e,!a.inhibitButton){var f=d.$root.find(".ngFooterPanel"),g=d.$root.find(".ngFooterPanel .pdf-data-link-span");null!=g&&g.remove();var h='<button class="pdf-data-link-span">PDF Export</button>';f.append(h),f.on("click",function(){b.createPDF()})}},b.createPDF=function(){var a=[],c=[],d={},e=b.scope.totalRowWidth(),f=15;angular.forEach(b.scope.columns,function(c){c.visible&&(void 0===c.width||c.width>0)&&(a.push({name:c.field,prompt:c.displayName,width:c.width*(185/e),align:c.colDef.align||"left"}),c.colDef.totalsRow&&(d[c.field]=b.scope.getTotalVal(c.field,c.filter).toString()))}),angular.forEach(b.grid.filteredRows,function(a){c.push(angular.copy(a.entity))});var g=new jsPDF("landscape","mm","a4");g.setFontStyle("bold"),g.setFontSize(24),g.text(b.scope.reportSchema.title,f,f),g.setFontStyle("normal"),g.setFontSize(12),g.cellInitialize(),g.table(f,24,c,{headers:a,footers:d,printHeaders:!0,autoSize:!1,margins:{left:f,top:f,bottom:f,width:g.internal.pageSize-f}}),g.output("dataurlnewwindow")}}formsAngular.controller("AnalysisCtrl",["$filter","$scope","$http","$location","cssFrameworkService","routingService",function(a,b,c,d,e,f){var g=!0,h=new ngGridPdfExportPlugin({inhibitButton:!0}),i=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(b,f.parsePathFunc()(d.$$path)),b.reportSchema={},b.gridOptions={columnDefs:"reportSchema.columnDefs",data:"report",showColumnMenu:!0,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResize:!0,footerRowHeight:65,multiSelect:!1,plugins:[h,i],afterSelectionChange:function(a){var c=b.reportSchema.drilldown;c&&(c=f.buildUrl(c.replace(/\|.+?\|/g,function(c){var d=c.slice(1,-1),e=/\((.+)\)/.exec(d);return e?b.reportSchema.params[e[1]].value:a.entity[d]})),window.location=c)},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},b.report=[],!b.reportSchemaName&&d.$$search.r)switch(d.$$search.r.slice(0,1)){case"[":b.reportSchema.pipeline=JSON.parse(d.$$search.r);break;case"{":angular.extend(b.reportSchema,JSON.parse(d.$$search.r));break;default:throw new Error("No report instructions specified")}b.getTotalVal=function(c,d){var e="",f=_.find(b.reportSchema.columnDefs,function(a){return a.field===c});if(f)switch(f.totalsRow){case void 0:break;case"$SUM":for(var g=0,h=0;h<b.report.length;h++)g+=b.report[h][c];e=g,d&&(e=a(d)(e));break;default:e=f.totalsRow}return e},b.$on("exportToPDF",function(){h.createPDF()}),b.$on("exportToCSV",function(){i.createCSV()}),b.refreshQuery=function(){var f="/api/report/"+b.modelName,h="?";if(b.reportSchemaName&&(f+="/"+b.reportSchemaName),b.paramSchema){for(var i in b.record)if(b.record.hasOwnProperty(i)){var j=b.reportSchema.params[i];if(b.record[i]&&""!==b.record[i])b.param=b.record[i],j.conversionExpression&&(b.param=b.$eval(j.conversionExpression)),f+=h+i+"="+b.param,h="&";else if(j.required)return}}else{var k=d.$$url.match(/\?.*/);k&&(f+=h+k[0].slice(1))}c.get(f).success(function(c){if(c.success){if(b.report=c.report,b.reportSchema=c.schema,b.reportSchema.title=b.reportSchema.title||b.modelName,b.reportSchema.title=b.reportSchema.title.replace(/\|.+?\|/g,function(a){var c=a.slice(1,-1),d=/\((.+)\)/.exec(c);return d?b.reportSchema.params[d[1]].value:""}),g&&(g=!1,b.$watch("reportSchema.columnDefs",function(a){var c=!1;if(a)for(var d=0;d<a.length;d++)if(a[d].totalsRow&&(c=!0),a[d].align){var e="fng-"+a[d].align;a[d].cellClass=a[d].cellClass||"",-1===a[d].cellClass.indexOf(e)&&(a[d].cellClass=a[d].cellClass+" "+e)}b.gridOptions.showTotals=c,b.gridOptions.reallyShowFooter=c,b.gridOptions.footerRowHeight=55+(c?10:0)},!0),!b.paramSchema&&c.schema.params)){b.paramSchema=[],b.record={};for(var d in c.schema.params)if(c.schema.params.hasOwnProperty(d)){var f=c.schema.params[d];if(!f.noInput){var h=b.paramSchema.push({name:d,id:"fp_"+d,label:f.label||a("titleCase")(d),type:f.type||"text",required:!0,add:f.add||void 0,size:f.size||("bs3"===e.frameWork?"large":"medium")});"select"===f.type&&(b[d+"_Opts"]=f["enum"],b.paramSchema[h-1].options=d+"_Opts")}var i=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(f.value);i&&(f.value=moment(i[1]).format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"),b.record[d]=f.value}b.$watch("record",function(a,c){c!==a&&b.refreshQuery()},!0)}}else console.log(JSON.stringify(c)),b.reportSchema.title="Error - see console log"}).error(function(a){console.log(JSON.stringify(a)),d.path("/404")})},b.refreshQuery()}]);var COL_FIELD=/COL_FIELD/g;formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(a,b){var c={scope:!1,compile:function(){return{pre:function(b,c){var d,e,f=b.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);e=f?b.col.cellTemplate.replace("COL_FIELD |"+f[1],'getTotalVal("'+b.col.field+'","'+f[1]+'")'):b.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+b.col.field+'")'),b.col.enableCellEdit?(d=b.col.cellEditTemplate,d=d.replace(DISPLAY_CELL_TEMPLATE,e),d=d.replace(EDITABLE_CELL_TEMPLATE,b.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+b.col.field))):d=e;var g=a(d)(b);b.enableCellSelection&&-1===g[0].className.indexOf("ngSelectionCell")&&(g[0].setAttribute("tabindex",0),g.addClass("ngCellElement")),c.append(g)},post:function(a,c){a.enableCellSelection&&a.domAccessProvider.selectionHandlers(a,c),a.$on("ngGridEventDigestCell",function(){b.digest(a)})}}}};return c}]),function(a){var b,c,d,e,f=3,g=13,h={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},i=1,j=function(a,b,c,d,e){h={x:a,y:b,w:c,h:d,ln:e}},k=function(){return h};a.setHeaderFunction=function(a){e=a},a.getTextDimensions=function(a){b=this.internal.getFont().fontName,c=this.table_font_size||this.internal.getFontSize(),d=this.internal.getFont().fontStyle;var e,f,g=19.049976/25.4;return f=document.createElement("font"),f.id="jsPDFCell",f.style.fontStyle=d,f.style.fontName=b,f.style.fontSize=c+"pt",f.innerText=a,document.body.appendChild(f),e={w:(f.offsetWidth+1)*g,h:(f.offsetHeight+1)*g},document.body.removeChild(f),e},a.cellAddPage=function(){this.addPage(),j(this.margins.left,this.margins.top,void 0,void 0),i+=1},a.cellInitialize=function(){h={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},i=1},a.cell=function(a,b,c,d,e,h,i){var l=k();if(void 0!==l.ln&&(l.ln===h?(a=l.x+l.w,b=l.y):(l.y+l.h+d+g>=this.internal.pageSize.height-this.margins.bottom&&(this.cellAddPage(),this.printHeaders&&this.tableHeaderRow&&this.printHeaderRow(h,!0)),b=k().y+k().h)),void 0!==e[0])if(this.printingHeaderRow?this.rect(a,b,c,d,"FD"):this.rect(a,b,c,d),"right"===i){var m;if(e instanceof Array)for(var n=0;n<e.length;n++){var o=e[n];m=this.getStringUnitWidth(o)*this.internal.getFontSize()/2.8125,this.text(o,a+c-m-f,b+this.internal.getLineHeight()*(n+1))}else m=this.getStringUnitWidth(e)*this.internal.getFontSize()/2.8125,this.text(e,a+c-m-f,b+this.internal.getLineHeight())}else this.text(e,a+f,b+this.internal.getLineHeight());return j(a,b,c,d,h),this},a.getKeys="function"==typeof Object.keys?function(a){return a?Object.keys(a):[]}:function(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(b);return c},a.arrayMax=function(a,b){var c,d,e,f=a[0];for(c=0,d=a.length;d>c;c+=1)e=a[c],b?-1===b(f,e)&&(f=e):e>f&&(f=e);return f},a.table=function(b,c,d,e){if(!d)throw"No data for PDF table";var f,g,j,k,l,m,n,o,p,q,r=[],s=[],t={},u={},v=[],w=[],x=[],y=!1,z=!0,A=12,B=null,C=null,D={left:0,top:0,bottom:0,width:this.internal.pageSize.width};if(e&&(e.autoSize===!0&&(y=!0),e.printHeaders===!1&&(z=!1),e.fontSize&&(A=e.fontSize),e.margins&&(D=e.margins),e.headers&&(B=e.headers),e.footers&&(C=e.footers)),this.lnMod=0,h={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},i=1,this.printHeaders=z,this.margins=D,this.setFontSize(A),this.table_font_size=A,void 0===B||null===B)r=this.getKeys(d[0]);else if(B[0]&&"string"!=typeof B[0]){var E=1.5;for(g=0,j=B.length;j>g;g+=1)f=B[g],r.push(f.name),s.push(f.prompt),u[f.name]=f.width*E,w[f.name]=f.align}else r=B;if(y)for(q=function(a){return a[f]},g=0,j=r.length;j>g;g+=1){for(f=r[g],t[f]=d.map(q),v.push(this.getTextDimensions(s[g]||f).w),m=t[f],n=0,k=m.length;k>n;n+=1)l=m[n],v.push(this.getTextDimensions(l).w);C&&v.push(this.getTextDimensions(C[g]).w),u[f]=a.arrayMax(v)}if(z){var F=this.calculateLineHeight(r,u,s.length?s:r);for(g=0,j=r.length;j>g;g+=1)f=r[g],x.push([b,c,u[f],F,String(s.length?s[g]:f),0,w[f]]);this.setTableHeaderRow(x),this.printHeaderRow(1,!1)}for(g=0,j=d.length;j>g;g+=1){var F;for(o=d[g],F=this.calculateLineHeight(r,u,o),n=0,p=r.length;p>n;n+=1)f=r[n],this.cell(b,c,u[f],F,o[f],g+2,w[f])}if(C){for(var G=0;G<r.length;G++)f=r[G],x[G][4]=C[f]||" ";this.printHeaderRow(g+2,!1)}return this.table_x=b,this.table_y=c,this},a.calculateLineHeight=function(a,b,c){for(var d,e=0,g=0;g<a.length;g++){d=a[g],c[d]=this.splitTextToSize(String(c[d]),b[d]-f);var h=this.internal.getLineHeight()*c[d].length+f;h>e&&(e=h)}return e},a.setTableHeaderRow=function(a){this.tableHeaderRow=a},a.printHeaderRow=function(a,b){if(!this.tableHeaderRow)throw"Property tableHeaderRow does not exist.";var c,d,f,g;if(this.printingHeaderRow=!0,void 0!==e){var h=e(this,i);j(h[0],h[1],h[2],h[3],-1)}this.setFontStyle("bold");var k=[];for(f=0,g=this.tableHeaderRow.length;g>f;f+=1)this.setFillColor(200,200,200),c=this.tableHeaderRow[f],b&&(c[1]=this.margins.top,k.push(c)),d=[].concat(c),d[5]=a,this.cell.apply(this,d);k.length>0&&this.setTableHeaderRow(k),this.setFontStyle("normal"),this.printingHeaderRow=!1}}(jsPDF.API);