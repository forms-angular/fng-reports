/*! forms-angular 2020-04-09 */

"use strict";formsAngular.controller("AnalysisCtrl",["$rootScope","$window","$filter","$scope","$http","$location","cssFrameworkService","routingService",function(e,t,o,l,i,s,c,n){var g=!0,r=new ngGridPdfExportPlugin({inhibitButton:!0}),a=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(l,n.parsePathFunc()(s.$$path)),l.reportSchema={columnDefs:[]},l.gridOptions={data:"report",columnDefs:l.reportSchema.columnDefs,showColumnMenu:!0,enableRowHeaderSelection:!1,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResizing:!0,footerRowHeight:65,multiSelect:!1,plugins:[r,a],onRegisterApi:function(t){l.gridApi=t,l.gridOptions.plugins.forEach(function(e){e.init(l,t.grid,null)}),t.selection.on.rowSelectionChanged(l,function(r){var e=l.reportSchema.drilldown;e&&(e=n.buildUrl(e.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),n=/\((.+)\)/.exec(t);return n?l.reportSchema.params[n[1]].value:r.entity[t]})),window.location=e)})},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},l.report=[],!l.reportSchemaName&&s.$$search.r)switch(s.$$search.r.slice(0,1)){case"[":l.reportSchema.pipeline=JSON.parse(s.$$search.r);break;case"{":angular.extend(l.reportSchema,JSON.parse(s.$$search.r));break;default:throw new Error("No report instructions specified")}l.getTotalVal=function(t,e){var n="",r=_.find(l.reportSchema.columnDefs,function(e){return e.field===t});if(r)switch(r.totalsRow){case void 0:break;case"$SUM":for(var a=0,i=0;i<l.report.length;i++)a+=l.report[i][t];n=a,e&&(n=o(e)(n));break;default:n=r.totalsRow}return n},l.$on("exportToPDF",function(){r.createPDF()}),l.$on("exportToCSV",function(){a.createCSV()});var d=document.querySelector("div.report-grow");if(d){var p=d.offsetLeft,u=d.offsetTop+p,h=document.querySelector("div.ui-grid-header"),f=h?h.clientHeight:31,m=Math.floor((t.innerHeight-u-f-p)/30);angular.element(d).css("height",30*m+"px")}l.inhibitRefresh||(l.refreshQuery=function(){var e="/api/report/"+l.modelName,t="?";if(l.reportSchemaName&&(e+="/"+l.reportSchemaName),l.paramSchema){for(var n in l.record)if(l.record.hasOwnProperty(n)){var r=l.reportSchema.params[n];if(l.record[n]&&""!==l.record[n])l.param=l.record[n],r.conversionExpression&&(l.param=l.$eval(r.conversionExpression)),e+=t+n+"="+l.param,t="&";else if(r.required)return}}else{var a=s.$$url.match(/\?.*/);a&&(e+=t+a[0].slice(1))}return i.get(e).then(function(e){var t=e.data;if(t.success){if(l.report=t.report,l.reportSchema=t.schema,l.reportSchema.title=l.reportSchema.title||l.modelName,l.reportSchema.title=l.reportSchema.title.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),n=/\((.+)\)/.exec(t);return n?l.reportSchema.params[n[1]].value:""}),g&&(g=!1,l.$watch("reportSchema.columnDefs",function(e){var t=!1;if(e){for(var n=0;n<e.length;n++)if(e[n].totalsRow&&(t=!0),e[n].align){var r="fng-"+e[n].align;e[n].cellClass=e[n].cellClass||"",-1===e[n].cellClass.indexOf(r)&&(e[n].cellClass=e[n].cellClass+" "+r)}e.forEach(function(e){e.width&&"string"==typeof e.width&&-1!==e.width.indexOf("px")&&(e.width=parseInt(e.width.slice(0,-2)))}),l.gridOptions.columnDefs=e}l.gridOptions.showTotals=t,l.gridOptions.reallyShowFooter=t,l.gridOptions.footerRowHeight=55+(t?10:0)},!0),!l.paramSchema&&t.schema.params)){for(var n in l.paramSchema=[],l.record={},t.schema.params)if(t.schema.params.hasOwnProperty(n)){var r=t.schema.params[n];if(!r.noInput){var a=l.paramSchema.push({name:n,id:"fp_"+n,label:r.label||o("titleCase")(n),type:r.type||"text",required:!0,add:r.add||void 0,size:r.size||("bs3"===c.frameWork?"large":"medium")});"select"===r.type&&(l[n+"_Opts"]=r.enum,l.paramSchema[a-1].options=n+"_Opts")}var i=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(r.value);i&&(r.value=moment(i[1]).format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"),l.record[n]=r.value}l.$watch("record",function(e,t){t!==e&&l.refreshQuery()},!0)}}else console.log(JSON.stringify(t)),l.reportSchema.title="Error - see console log"},function(e){console.log(JSON.stringify(e)),s.path("/404")})},l.refreshQuery());var v=e.navScope;v.items=[{fn:r.createPDF,text:"Save as PDF"},{fn:a.createCSV,text:"Export as CSV"}],v.contextMenu="Report"}]);var COL_FIELD=/COL_FIELD/g;function ngGridCsvExportPlugin(a){var i=this;i.grid=null,i.scope=null,i.services=null,i.init=function(n,e,t){function r(){var e=angular.element("h1").parent(),t=angular.element("#csv-data-link");null!=t&&t.remove();var n='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';n+=encodeURIComponent(i.prepareCSV()),n+='" download="Export.csv">CSV Export</button>',e.append(n)}i.grid=e,i.scope=n,i.services=t,a.inhibitButton||(setTimeout(r,0),n.catHashKeys=function(){var e="";for(var t in n.renderedRows)e+=n.renderedRows[t].$$hashKey;return e},n.$watch("catHashKeys()",r))},i.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(i.prepareCSV()))},i.prepareCSV=function(){function n(e){return null==e?"":"number"==typeof e?""+e:"boolean"==typeof e?e?"TRUE":"FALSE":"string"==typeof e?e.replace(/"/g,'""'):JSON.stringify(e).replace(/"/g,'""')}function e(e){return e.substr(0,e.length-1)+"\n"}var r="";return angular.forEach(i.grid.columns,function(e){e.visible&&(void 0===e.width||"*"===e.width||0<e.width)&&(r+='"'+n(e.displayName)+'",')}),r=e(r),angular.forEach(i.grid.rows,function(t){t.visible&&(angular.forEach(i.grid.columns,function(e){e.visible&&(r+='"'+n(t.entity[e.field])+'",')}),r=e(r))}),r}}function ngGridPdfExportPlugin(i){var o=this;o.grid=null,o.scope=null,o.services=null,o.options=i,o.init=function(e,t,n){if(o.grid=t,o.scope=e,o.services=n,!i.inhibitButton){var r=t.$root.find(".ngFooterPanel"),a=t.$root.find(".ngFooterPanel .pdf-data-link-span");null!=a&&a.remove();r.append('<button class="pdf-data-link-span">PDF Export</button>'),r.on("click",function(){o.createPDF()})}},o.createPDF=function(){var t=[],r=[],n=[],e=[];angular.forEach(o.grid.columns,function(e){e.visible&&(t.push(e.displayName),r.push(e.field)),e.colDef.totalsRow&&(n[e.field]=o.grid.getTotalVal(e.field,e.filter).toString())}),angular.forEach(o.grid.rows,function(t){var n=[];t.visible&&(r.forEach(function(e){n.push(t.entity[e])}),e.push(n))});var a=new jsPDF("landscape","mm","a4");a.autoTable({head:[t],body:e}),window.open(a.output("bloburl"))}}formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(o,n){return{scope:!1,compile:function(){return{pre:function(e,t){var n,r,a=e.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);r=a?e.col.cellTemplate.replace("COL_FIELD |"+a[1],'getTotalVal("'+e.col.field+'","'+a[1]+'")'):e.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+e.col.field+'")'),n=e.col.enableCellEdit?(n=(n=e.col.cellEditTemplate).replace(DISPLAY_CELL_TEMPLATE,r)).replace(EDITABLE_CELL_TEMPLATE,e.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+e.col.field)):r;var i=o(n)(e);e.enableCellSelection&&-1===i[0].className.indexOf("ngSelectionCell")&&(i[0].setAttribute("tabindex",0),i.addClass("ngCellElement")),t.append(i)},post:function(e,t){e.enableCellSelection&&e.domAccessProvider.selectionHandlers(e,t),e.$on("ngGridEventDigestCell",function(){n.digest(e)})}}}}}]);