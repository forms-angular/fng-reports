/*! forms-angular 2020-09-09 */

"use strict";formsAngular.controller("AnalysisCtrl",["$rootScope","$window","$filter","$scope","$http","$location","cssFrameworkService","routingService",function(e,r,l,c,s,p,u,t){var f=!0,i=new ngGridPdfExportPlugin({inhibitButton:!0}),o=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(c,t.parsePathFunc()(p.$$path)),c.reportSchema={columnDefs:[]},c.gridOptions={data:"report",columnDefs:c.reportSchema.columnDefs,showColumnMenu:!0,enableRowHeaderSelection:!1,enableFiltering:!1,showGridFooter:!1,reallyShowFooter:!1,showTotals:!0,enableColumnResizing:!0,footerRowHeight:65,multiSelect:!1,plugins:[i,o],onRegisterApi:function(r){c.gridApi=r,c.gridOptions.plugins.forEach(function(e){e.init(c,r.grid,null)}),r.selection.on.rowSelectionChanged(c,function(o){var e=c.reportSchema.drilldown;e&&(e=t.buildUrl(e.replace(/\|.+?\|/g,function(e){var r=e.slice(1,-1),t=/\((.+)\)/.exec(r);if(!t)return o.entity[r];var i=c.reportSchema.params[t[1]];return i?(c.param=c.record[t[1]],i.conversionExpression?c.$eval(i.conversionExpression):void 0):c.reportSchema.params[t[1]].value})),window.location=e)})}},c.report=[],!c.reportSchemaName&&p.$$search.r)switch(p.$$search.r.slice(0,1)){case"[":c.reportSchema.pipeline=JSON.parse(p.$$search.r);break;case"{":angular.extend(c.reportSchema,JSON.parse(p.$$search.r));break;default:throw new Error("No report instructions specified")}c.getTotalVal=function(r,e){var t="",i=_.find(c.reportSchema.columnDefs,function(e){return e.field===r});if(i)switch(i.totalsRow){case void 0:break;case"$SUM":for(var o=0,n=0;n<c.report.length;n++)o+=c.report[n][r];t=o,e&&(t=l(e)(t));break;default:t=i.totalsRow}return t},c.$on("exportToPDF",function(){i.createPDF()}),c.$on("exportToCSV",function(){o.createCSV()}),c.extractFilter=function(e,r){if(e.cellFilter){var t,i,o=e.cellFilter.indexOf(":");-1===o?t=e.cellFilter:(t=e.cellFilter.slice(0,o).trim(),"'"!==(i=e.cellFilter.slice(o+1,999).trim())[0]&&'"'!==i[0]||(i=i.slice(1,-1)));var n=angular.element(document.body).injector().get("$filter")(t.trim());r[e.field]={filter:n,filterParam:i}}};var n=document.querySelector("div.report-grow");if(n){var a=n.offsetLeft,d=n.offsetTop+a,m=document.querySelector("div.ui-grid-header"),h=m?m.clientHeight:31,g=Math.floor((r.innerHeight-d-h-a)/30);angular.element(n).css("height",30*g+"px")}var v=e.navScope;v.items=[{fn:i.createPDF,text:"Save as PDF"},{fn:o.createCSV,text:"Export as CSV"}],v.contextMenu="Report",c.titleWithSubstitutions=c.reportSchema.title,c.inhibitRefresh||(c.refreshQuery=function(){function a(e){return e.replace(/\|.+?\|/g,function(e){var r=e.slice(1,-1),t=/\((.+)\)/.exec(r);return t?c.reportSchema.params[t[1]].value:""})}var e="/api/report/"+c.modelName,r="?",t=!1,i=p.$$url.match(/\?.*/);if(c.reportSchemaName?e+="/"+c.reportSchemaName:i&&(e+=r+i[0].slice(1),r="&",t=!0),c.paramSchema){for(var o in c.record)if(c.record.hasOwnProperty(o)){var n=c.reportSchema.params[o];if(c.record[o]&&""!==c.record[o])c.param=c.record[o],n.conversionExpression&&(c.param=c.$eval(n.conversionExpression)),e+=r+o+"="+c.param,r="&";else if(n.required)return}}else!t&&i&&(e+=r+i[0].slice(1),r="&");return s.get(e).then(function(e){var r=e.data;if(r.success){if(c.report=r.report,c.reportSchema=r.schema,c.reportSchema.title=c.reportSchema.title||c.modelName,c.titleWithSubstitutions=a(c.reportSchema.title),c.gridOptions.enableFiltering=!!c.reportSchema.filter,v&&v.items&&(v.items.length=2,c.reportSchema.menu&&c.reportSchema.menu.forEach(function(e){v.items.push(JSON.parse(a(JSON.stringify(e))))})),f&&(f=!1,c.$watch("reportSchema.columnDefs",function(e){var r=!1;if(e){for(var t=0;t<e.length;t++)if(e[t].totalsRow&&(r=!0),e[t].align){var i="fng-"+e[t].align;e[t].cellClass=e[t].cellClass||"",-1===e[t].cellClass.indexOf(i)&&(e[t].cellClass=e[t].cellClass+" "+i)}e.forEach(function(e){e.width&&"string"==typeof e.width&&-1!==e.width.indexOf("px")&&(e.width=parseInt(e.width.slice(0,-2)))}),c.gridOptions.columnDefs=e}c.gridOptions.showTotals=r,c.gridOptions.reallyShowFooter=r,c.gridOptions.footerRowHeight=55+(r?10:0)},!0),!c.paramSchema&&r.schema.params)){for(var t in c.paramSchema=[],c.record={},r.schema.params)if(r.schema.params.hasOwnProperty(t)){var i=r.schema.params[t];if(!i.noInput){var o=c.paramSchema.push({name:t,id:"fp_"+t,label:i.label||l("titleCase")(t),type:i.type||"text",required:!0,add:i.add||void 0,size:i.size||("bs3"===u.frameWork?"large":"medium")});"select"===i.type&&(c[t+"_Opts"]=i.enum,c.paramSchema[o-1].options=t+"_Opts")}var n=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(i.value);n&&(i.value=new Date(n[1])),c.record[t]=i.value}c.$watch("record",function(e,r){r!==e&&c.refreshQuery()},!0)}}else console.log(JSON.stringify(r)),c.reportSchema.title="Error - see console log"},function(e){console.log(JSON.stringify(e)),p.url("/404")})},c.refreshQuery()),c.$on("$locationChangeStart",function(){delete v.contextMenu,delete v.items})}]);var COL_FIELD=/COL_FIELD/g;function ngGridCsvExportPlugin(e){var n=this;n.grid=null,n.scope=null,n.services=null,n.init=function(e,r,t){n.grid=r,n.scope=e,n.services=t},n.createCSV=function(){!function(e,r){var t=document.createElement("a");t.download=e,t.href=r;var i=new MouseEvent("click");t.dispatchEvent(i)}(n.scope.reportSchema.title+".csv","data:text/csv;charset=UTF-8,"+encodeURIComponent(n.prepareCSV()))},n.prepareCSV=function(){function t(e,r){return null==e?"":r?r.filter(e,r.filterParam):"number"==typeof e?""+e:"boolean"==typeof e?e?"TRUE":"FALSE":"string"==typeof e?e.replace(/"/g,'""'):JSON.stringify(e).replace(/"/g,'""')}function e(e){return e.substr(0,e.length-1)+"\n"}var i="",o={};return angular.forEach(n.grid.columns,function(e){n.scope.extractFilter(e,o),e.visible&&(void 0===e.width||"*"===e.width||0<e.width)&&(i+='"'+t(e.displayName)+'",')}),i=e(i),angular.forEach(n.grid.rows,function(r){r.visible&&(angular.forEach(n.grid.columns,function(e){e.visible&&(i+='"'+t(r.entity[e.field],o[e.field])+'",')}),i=e(i))}),i}}function ngGridPdfExportPlugin(n){var a=this;a.grid=null,a.scope=null,a.services=null,a.options=n,a.init=function(e,r,t){if(a.grid=r,a.scope=e,a.services=t,!n.inhibitButton){var i=r.$root.find(".ngFooterPanel"),o=r.$root.find(".ngFooterPanel .pdf-data-link-span");null!=o&&o.remove();i.append('<button class="pdf-data-link-span">PDF Export</button>'),i.on("click",function(){a.createPDF()})}},a.createPDF=function(){var r=[],o=[],t=[],e=[],n={};angular.forEach(a.grid.columns,function(e){e.visible&&(r.push(e.displayName),o.push(e.field)),e.colDef.totalsRow&&(t[e.field]=a.grid.getTotalVal(e.field,e.filter).toString()),a.scope.extractFilter(e,n)}),angular.forEach(a.grid.rows,function(t){var i=[];t.visible&&(o.forEach(function(e){var r=t.entity[e];n[e]&&(r=n[e].filter(r,n[e].filterParam)),i.push(r)}),e.push(i))});var i=new jsPDF("landscape","mm","a4");i.autoTable({head:[r],body:e}),window.open(i.output("bloburl"))}}formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(a,t){return{scope:!1,compile:function(){return{pre:function(e,r){var t,i,o=e.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);i=o?e.col.cellTemplate.replace("COL_FIELD |"+o[1],'getTotalVal("'+e.col.field+'","'+o[1]+'")'):e.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+e.col.field+'")'),t=e.col.enableCellEdit?(t=(t=e.col.cellEditTemplate).replace(DISPLAY_CELL_TEMPLATE,i)).replace(EDITABLE_CELL_TEMPLATE,e.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+e.col.field)):i;var n=a(t)(e);e.enableCellSelection&&-1===n[0].className.indexOf("ngSelectionCell")&&(n[0].setAttribute("tabindex",0),n.addClass("ngCellElement")),r.append(n)},post:function(e,r){e.enableCellSelection&&e.domAccessProvider.selectionHandlers(e,r),e.$on("ngGridEventDigestCell",function(){t.digest(e)})}}}}}]);