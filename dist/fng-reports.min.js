/*! forms-angular 2019-02-09 */

"use strict";formsAngular.controller("AnalysisCtrl",["$filter","$scope","$http","$location","cssFrameworkService","routingService",function(o,l,r,s,c,t){var g=!0,e=new ngGridPdfExportPlugin({inhibitButton:!0}),n=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(l,t.parsePathFunc()(s.$$path)),l.reportSchema={columnDefs:[]},l.gridOptions={data:"report",columnDefs:l.reportSchema.columnDefs,showColumnMenu:!0,enableRowHeaderSelection:!1,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResize:!0,footerRowHeight:65,multiSelect:!1,plugins:[e,n],onRegisterApi:function(e){(l.gridApi=e).selection.on.rowSelectionChanged(l,function(i){var e=l.reportSchema.drilldown;e&&(e=t.buildUrl(e.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),n=/\((.+)\)/.exec(t);return n?l.reportSchema.params[n[1]].value:i.entity[t]})),window.location=e)})},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},l.report=[],!l.reportSchemaName&&s.$$search.r)switch(s.$$search.r.slice(0,1)){case"[":l.reportSchema.pipeline=JSON.parse(s.$$search.r);break;case"{":angular.extend(l.reportSchema,JSON.parse(s.$$search.r));break;default:throw new Error("No report instructions specified")}l.getTotalVal=function(t,e){var n="",i=_.find(l.reportSchema.columnDefs,function(e){return e.field===t});if(i)switch(i.totalsRow){case void 0:break;case"$SUM":for(var a=0,r=0;r<l.report.length;r++)a+=l.report[r][t];n=a,e&&(n=o(e)(n));break;default:n=i.totalsRow}return n},l.$on("exportToPDF",function(){e.createPDF()}),l.$on("exportToCSV",function(){n.createCSV()}),l.refreshQuery=function(){var e="/api/report/"+l.modelName,t="?";if(l.reportSchemaName&&(e+="/"+l.reportSchemaName),l.paramSchema){for(var n in l.record)if(l.record.hasOwnProperty(n)){var i=l.reportSchema.params[n];if(l.record[n]&&""!==l.record[n])l.param=l.record[n],i.conversionExpression&&(l.param=l.$eval(i.conversionExpression)),e+=t+n+"="+l.param,t="&";else if(i.required)return}}else{var a=s.$$url.match(/\?.*/);a&&(e+=t+a[0].slice(1))}r.get(e).then(function(e){var t=e.data;if(t.success){if(l.report=t.report,l.reportSchema=t.schema,l.reportSchema.title=l.reportSchema.title||l.modelName,l.reportSchema.title=l.reportSchema.title.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),n=/\((.+)\)/.exec(t);return n?l.reportSchema.params[n[1]].value:""}),g&&(g=!1,l.$watch("reportSchema.columnDefs",function(e){var t=!1;if(e){for(var n=0;n<e.length;n++)if(e[n].totalsRow&&(t=!0),e[n].align){var i="fng-"+e[n].align;e[n].cellClass=e[n].cellClass||"",-1===e[n].cellClass.indexOf(i)&&(e[n].cellClass=e[n].cellClass+" "+i)}e.forEach(function(e){e.width&&"string"==typeof e.width&&-1!==e.width.indexOf("px")&&(e.width=parseInt(e.width.slice(0,-2)))}),l.gridOptions.columnDefs=e}l.gridOptions.showTotals=t,l.gridOptions.reallyShowFooter=t,l.gridOptions.footerRowHeight=55+(t?10:0)},!0),!l.paramSchema&&t.schema.params)){for(var n in l.paramSchema=[],l.record={},t.schema.params)if(t.schema.params.hasOwnProperty(n)){var i=t.schema.params[n];if(!i.noInput){var a=l.paramSchema.push({name:n,id:"fp_"+n,label:i.label||o("titleCase")(n),type:i.type||"text",required:!0,add:i.add||void 0,size:i.size||("bs3"===c.frameWork?"large":"medium")});"select"===i.type&&(l[n+"_Opts"]=i.enum,l.paramSchema[a-1].options=n+"_Opts")}var r=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(i.value);r&&(i.value=moment(r[1]).format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"),l.record[n]=i.value}l.$watch("record",function(e,t){t!==e&&l.refreshQuery()},!0)}}else console.log(JSON.stringify(t)),l.reportSchema.title="Error - see console log"},function(e){console.log(JSON.stringify(e)),s.path("/404")})},l.refreshQuery()}]);var COL_FIELD=/COL_FIELD/g;function ngGridCsvExportPlugin(a){var r=this;r.grid=null,r.scope=null,r.init=function(n,e,t){function i(){var e=angular.element("h1").parent(),t=angular.element("#csv-data-link");null!=t&&t.remove();var n='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';n+=encodeURIComponent(r.prepareCSV()),n+='" download="Export.csv">CSV Export</button>',e.append(n)}r.grid=e,r.scope=n,a.inhibitButton||(setTimeout(i,0),n.catHashKeys=function(){var e="";for(var t in n.renderedRows)e+=n.renderedRows[t].$$hashKey;return e},n.$watch("catHashKeys()",i))},r.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(r.prepareCSV()))},r.prepareCSV=function(){function n(e){return null==e?"":"number"==typeof e?""+e:"boolean"==typeof e?e?"TRUE":"FALSE":"string"==typeof e?e.replace(/"/g,'""'):JSON.stringify(e).replace(/"/g,'""')}function e(e){return e.substr(0,e.length-1)+"\n"}var i="";return angular.forEach(r.scope.columns,function(e){e.visible&&(void 0===e.width||0<e.width)&&(i+='"'+n(e.displayName)+'",')}),i=e(i),angular.forEach(r.grid.filteredRows,function(t){angular.forEach(r.scope.columns,function(e){e.visible&&(i+='"'+n(t.entity[e.field])+'",')}),i=e(i)}),i}}function ngGridPdfExportPlugin(r){var o=this;o.grid=null,o.scope=null,o.services=null,o.options=r,o.init=function(e,t,n){if(o.grid=t,o.scope=e,o.services=n,!r.inhibitButton){var i=t.$root.find(".ngFooterPanel"),a=t.$root.find(".ngFooterPanel .pdf-data-link-span");null!=a&&a.remove();i.append('<button class="pdf-data-link-span">PDF Export</button>'),i.on("click",function(){o.createPDF()})}},o.createPDF=function(){var t=[],n=[],i={},a=o.scope.totalRowWidth();angular.forEach(o.scope.columns,function(e){e.visible&&(void 0===e.width||0<e.width)&&(t.push({name:e.field,prompt:e.displayName,width:e.width*(185/a),align:e.colDef.align||"left"}),e.colDef.totalsRow&&(i[e.field]=o.scope.getTotalVal(e.field,e.filter).toString()))}),angular.forEach(o.grid.filteredRows,function(e){n.push(angular.copy(e.entity))});var e=new jsPDF("landscape","mm","a4");e.setFontStyle("bold"),e.setFontSize(24),e.text(o.scope.reportSchema.title,15,15),e.setFontStyle("normal"),e.setFontSize(12),e.cellInitialize(),e.table(15,24,n,{headers:t,footers:i,printHeaders:!0,autoSize:!1,margins:{left:15,top:15,bottom:15,width:e.internal.pageSize-15}}),e.output("dataurlnewwindow")}}formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(o,n){return{scope:!1,compile:function(){return{pre:function(e,t){var n,i,a=e.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);i=a?e.col.cellTemplate.replace("COL_FIELD |"+a[1],'getTotalVal("'+e.col.field+'","'+a[1]+'")'):e.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+e.col.field+'")'),n=e.col.enableCellEdit?(n=(n=e.col.cellEditTemplate).replace(DISPLAY_CELL_TEMPLATE,i)).replace(EDITABLE_CELL_TEMPLATE,e.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+e.col.field)):i;var r=o(n)(e);e.enableCellSelection&&-1===r[0].className.indexOf("ngSelectionCell")&&(r[0].setAttribute("tabindex",0),r.addClass("ngCellElement")),t.append(r)},post:function(e,t){e.enableCellSelection&&e.domAccessProvider.selectionHandlers(e,t),e.$on("ngGridEventDigestCell",function(){n.digest(e)})}}}}}]),function(E){var a,r,o,s,R={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},D=1,d=function(e,t,n,i,a){R={x:e,y:t,w:n,h:i,ln:a}},h=function(){return R};E.setHeaderFunction=function(e){s=e},E.getTextDimensions=function(e){a=this.internal.getFont().fontName,r=this.table_font_size||this.internal.getFontSize(),o=this.internal.getFont().fontStyle;var t,n,i=19.049976/25.4;return(n=document.createElement("font")).id="jsPDFCell",n.style.fontStyle=o,n.style.fontName=a,n.style.fontSize=r+"pt",n.innerText=e,document.body.appendChild(n),t={w:(n.offsetWidth+1)*i,h:(n.offsetHeight+1)*i},document.body.removeChild(n),t},E.cellAddPage=function(){this.addPage(),d(this.margins.left,this.margins.top,void 0,void 0),D+=1},E.cellInitialize=function(){R={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},D=1},E.cell=function(e,t,n,i,a,r,o){var l,s=h();if(void 0!==s.ln&&(t=s.ln===r?(e=s.x+s.w,s.y):(s.y+s.h+i+13>=this.internal.pageSize.height-this.margins.bottom&&(this.cellAddPage(),this.printHeaders&&this.tableHeaderRow&&this.printHeaderRow(r,!0)),h().y+h().h)),void 0!==a[0])if(this.printingHeaderRow?this.rect(e,t,n,i,"FD"):this.rect(e,t,n,i),"right"===o)if(a instanceof Array)for(var c=0;c<a.length;c++){var g=a[c];l=this.getStringUnitWidth(g)*this.internal.getFontSize()/2.8125,this.text(g,e+n-l-3,t+this.internal.getLineHeight()*(c+1))}else l=this.getStringUnitWidth(a)*this.internal.getFontSize()/2.8125,this.text(a,e+n-l-3,t+this.internal.getLineHeight());else this.text(a,e+3,t+this.internal.getLineHeight());return d(e,t,n,i,r),this},E.getKeys="function"==typeof Object.keys?function(e){return e?Object.keys(e):[]}:function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(t);return n},E.arrayMax=function(e,t){var n,i,a,r=e[0];for(n=0,i=e.length;n<i;n+=1)a=e[n],t?-1===t(r,a)&&(r=a):r<a&&(r=a);return r},E.table=function(e,t,n,i){if(!n)throw"No data for PDF table";var a,r,o,l,s,c,g,d,h,p,u=[],f=[],m={},v={},w=[],S=[],b=[],y=!1,x=!0,P=12,T=null,F=null,C={left:0,top:0,bottom:0,width:this.internal.pageSize.width};if(i&&(!0===i.autoSize&&(y=!0),!1===i.printHeaders&&(x=!1),i.fontSize&&(P=i.fontSize),i.margins&&(C=i.margins),i.headers&&(T=i.headers),i.footers&&(F=i.footers)),this.lnMod=0,R={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},D=1,this.printHeaders=x,this.margins=C,this.setFontSize(P),this.table_font_size=P,null==T)u=this.getKeys(n[0]);else if(T[0]&&"string"!=typeof T[0]){for(r=0,o=T.length;r<o;r+=1)a=T[r],u.push(a.name),f.push(a.prompt),v[a.name]=1.5*a.width,S[a.name]=a.align}else u=T;if(y)for(p=function(e){return e[a]},r=0,o=u.length;r<o;r+=1){for(m[a=u[r]]=n.map(p),w.push(this.getTextDimensions(f[r]||a).w),g=0,l=(c=m[a]).length;g<l;g+=1)s=c[g],w.push(this.getTextDimensions(s).w);F&&w.push(this.getTextDimensions(F[r]).w),v[a]=E.arrayMax(w)}if(x){var L=this.calculateLineHeight(u,v,f.length?f:u);for(r=0,o=u.length;r<o;r+=1)a=u[r],b.push([e,t,v[a],L,String(f.length?f[r]:a),0,S[a]]);this.setTableHeaderRow(b),this.printHeaderRow(1,!1)}for(r=0,o=n.length;r<o;r+=1){for(d=n[r],L=this.calculateLineHeight(u,v,d),g=0,h=u.length;g<h;g+=1)a=u[g],this.cell(e,t,v[a],L,d[a],r+2,S[a])}if(F){for(var H=0;H<u.length;H++)a=u[H],b[H][4]=F[a]||" ";this.printHeaderRow(r+2,!1)}return this.table_x=e,this.table_y=t,this},E.calculateLineHeight=function(e,t,n){for(var i,a=0,r=0;r<e.length;r++){n[i=e[r]]=this.splitTextToSize(String(n[i]),t[i]-3);var o=this.internal.getLineHeight()*n[i].length+3;a<o&&(a=o)}return a},E.setTableHeaderRow=function(e){this.tableHeaderRow=e},E.printHeaderRow=function(e,t){if(!this.tableHeaderRow)throw"Property tableHeaderRow does not exist.";var n,i,a,r;if(this.printingHeaderRow=!0,void 0!==s){var o=s(this,D);d(o[0],o[1],o[2],o[3],-1)}this.setFontStyle("bold");var l=[];for(a=0,r=this.tableHeaderRow.length;a<r;a+=1)this.setFillColor(200,200,200),n=this.tableHeaderRow[a],t&&(n[1]=this.margins.top,l.push(n)),(i=[].concat(n))[5]=e,this.cell.apply(this,i);0<l.length&&this.setTableHeaderRow(l),this.setFontStyle("normal"),this.printingHeaderRow=!1}}(jsPDF.API);