/*! forms-angular 2019-07-23 */

"use strict";formsAngular.controller("AnalysisCtrl",["$rootScope","$filter","$scope","$http","$location","cssFrameworkService","routingService",function(e,l,o,i,s,c,a){var g=!0,t=new ngGridPdfExportPlugin({inhibitButton:!0}),n=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(o,a.parsePathFunc()(s.$$path)),o.reportSchema={columnDefs:[]},o.gridOptions={data:"report",columnDefs:o.reportSchema.columnDefs,showColumnMenu:!0,enableRowHeaderSelection:!1,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResize:!0,footerRowHeight:65,multiSelect:!1,plugins:[t,n],onRegisterApi:function(t){o.gridApi=t,o.gridOptions.plugins.forEach(function(e){e.init(o,t.grid,null)}),t.selection.on.rowSelectionChanged(o,function(n){var e=o.reportSchema.drilldown;e&&(e=a.buildUrl(e.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),a=/\((.+)\)/.exec(t);return a?o.reportSchema.params[a[1]].value:n.entity[t]})),window.location=e)})},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},o.report=[],!o.reportSchemaName&&s.$$search.r)switch(s.$$search.r.slice(0,1)){case"[":o.reportSchema.pipeline=JSON.parse(s.$$search.r);break;case"{":angular.extend(o.reportSchema,JSON.parse(s.$$search.r));break;default:throw new Error("No report instructions specified")}o.getTotalVal=function(t,e){var a="",n=_.find(o.reportSchema.columnDefs,function(e){return e.field===t});if(n)switch(n.totalsRow){case void 0:break;case"$SUM":for(var r=0,i=0;i<o.report.length;i++)r+=o.report[i][t];a=r,e&&(a=l(e)(a));break;default:a=n.totalsRow}return a},o.$on("exportToPDF",function(){t.createPDF()}),o.$on("exportToCSV",function(){n.createCSV()}),o.refreshQuery=function(){var e="/api/report/"+o.modelName,t="?";if(o.reportSchemaName&&(e+="/"+o.reportSchemaName),o.paramSchema){for(var a in o.record)if(o.record.hasOwnProperty(a)){var n=o.reportSchema.params[a];if(o.record[a]&&""!==o.record[a])o.param=o.record[a],n.conversionExpression&&(o.param=o.$eval(n.conversionExpression)),e+=t+a+"="+o.param,t="&";else if(n.required)return}}else{var r=s.$$url.match(/\?.*/);r&&(e+=t+r[0].slice(1))}return i.get(e).then(function(e){var t=e.data;if(t.success){if(o.report=t.report,o.reportSchema=t.schema,o.reportSchema.title=o.reportSchema.title||o.modelName,o.reportSchema.title=o.reportSchema.title.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),a=/\((.+)\)/.exec(t);return a?o.reportSchema.params[a[1]].value:""}),g&&(g=!1,o.$watch("reportSchema.columnDefs",function(e){var t=!1;if(e){for(var a=0;a<e.length;a++)if(e[a].totalsRow&&(t=!0),e[a].align){var n="fng-"+e[a].align;e[a].cellClass=e[a].cellClass||"",-1===e[a].cellClass.indexOf(n)&&(e[a].cellClass=e[a].cellClass+" "+n)}e.forEach(function(e){e.width&&"string"==typeof e.width&&-1!==e.width.indexOf("px")&&(e.width=parseInt(e.width.slice(0,-2)))}),o.gridOptions.columnDefs=e}o.gridOptions.showTotals=t,o.gridOptions.reallyShowFooter=t,o.gridOptions.footerRowHeight=55+(t?10:0)},!0),!o.paramSchema&&t.schema.params)){for(var a in o.paramSchema=[],o.record={},t.schema.params)if(t.schema.params.hasOwnProperty(a)){var n=t.schema.params[a];if(!n.noInput){var r=o.paramSchema.push({name:a,id:"fp_"+a,label:n.label||l("titleCase")(a),type:n.type||"text",required:!0,add:n.add||void 0,size:n.size||("bs3"===c.frameWork?"large":"medium")});"select"===n.type&&(o[a+"_Opts"]=n.enum,o.paramSchema[r-1].options=a+"_Opts")}var i=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(n.value);i&&(n.value=moment(i[1]).format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"),o.record[a]=n.value}o.$watch("record",function(e,t){t!==e&&o.refreshQuery()},!0)}}else console.log(JSON.stringify(t)),o.reportSchema.title="Error - see console log"},function(e){console.log(JSON.stringify(e)),s.path("/404")})},o.refreshQuery();var r=e.navScope;r.items=[{fn:t.createPDF,text:"Save as PDF"},{fn:n.createCSV,text:"Export as CSV"}],r.contextMenu="Report"}]);var COL_FIELD=/COL_FIELD/g;function ngGridCsvExportPlugin(r){var i=this;i.grid=null,i.scope=null,i.services=null,i.init=function(a,e,t){function n(){var e=angular.element("h1").parent(),t=angular.element("#csv-data-link");null!=t&&t.remove();var a='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';a+=encodeURIComponent(i.prepareCSV()),a+='" download="Export.csv">CSV Export</button>',e.append(a)}i.grid=e,i.scope=a,i.services=t,r.inhibitButton||(setTimeout(n,0),a.catHashKeys=function(){var e="";for(var t in a.renderedRows)e+=a.renderedRows[t].$$hashKey;return e},a.$watch("catHashKeys()",n))},i.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(i.prepareCSV()))},i.prepareCSV=function(){function a(e){return null==e?"":"number"==typeof e?""+e:"boolean"==typeof e?e?"TRUE":"FALSE":"string"==typeof e?e.replace(/"/g,'""'):JSON.stringify(e).replace(/"/g,'""')}function e(e){return e.substr(0,e.length-1)+"\n"}var n="";return angular.forEach(i.grid.columns,function(e){e.visible&&(void 0===e.width||"*"===e.width||0<e.width)&&(n+='"'+a(e.displayName)+'",')}),n=e(n),angular.forEach(i.grid.rows,function(t){t.visible&&(angular.forEach(i.grid.columns,function(e){e.visible&&(n+='"'+a(t.entity[e.field])+'",')}),n=e(n))}),n}}function ngGridPdfExportPlugin(i){var l=this;l.grid=null,l.scope=null,l.services=null,l.options=i,l.init=function(e,t,a){if(l.grid=t,l.scope=e,l.services=a,!i.inhibitButton){var n=t.$root.find(".ngFooterPanel"),r=t.$root.find(".ngFooterPanel .pdf-data-link-span");null!=r&&r.remove();n.append('<button class="pdf-data-link-span">PDF Export</button>'),n.on("click",function(){l.createPDF()})}},l.createPDF=function(){var t=[],n=[],a=[],e=[];angular.forEach(l.grid.columns,function(e){e.visible&&(t.push(e.displayName),n.push(e.field)),e.colDef.totalsRow&&(a[e.field]=l.grid.getTotalVal(e.field,e.filter).toString())}),angular.forEach(l.grid.rows,function(t){var a=[];t.visible&&(n.forEach(function(e){a.push(t.entity[e])}),e.push(a))});var r=new jsPDF("landscape","mm","a4");r.autoTable({head:[t],body:e}),window.open(r.output("bloburl"))}}formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(l,a){return{scope:!1,compile:function(){return{pre:function(e,t){var a,n,r=e.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);n=r?e.col.cellTemplate.replace("COL_FIELD |"+r[1],'getTotalVal("'+e.col.field+'","'+r[1]+'")'):e.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+e.col.field+'")'),a=e.col.enableCellEdit?(a=(a=e.col.cellEditTemplate).replace(DISPLAY_CELL_TEMPLATE,n)).replace(EDITABLE_CELL_TEMPLATE,e.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+e.col.field)):n;var i=l(a)(e);e.enableCellSelection&&-1===i[0].className.indexOf("ngSelectionCell")&&(i[0].setAttribute("tabindex",0),i.addClass("ngCellElement")),t.append(i)},post:function(e,t){e.enableCellSelection&&e.domAccessProvider.selectionHandlers(e,t),e.$on("ngGridEventDigestCell",function(){a.digest(e)})}}}}}]);