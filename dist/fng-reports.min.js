/*! forms-angular 2020-08-10 */

"use strict";formsAngular.controller("AnalysisCtrl",["$rootScope","$window","$filter","$scope","$http","$location","cssFrameworkService","routingService",function(e,r,i,l,a,c,s,t){var p=!0,n=new ngGridPdfExportPlugin({inhibitButton:!0}),o=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(l,t.parsePathFunc()(c.$$path)),l.reportSchema={columnDefs:[]},l.gridOptions={data:"report",columnDefs:l.reportSchema.columnDefs,showColumnMenu:!0,enableRowHeaderSelection:!1,enableFiltering:!1,showGridFooter:!1,reallyShowFooter:!1,showTotals:!0,enableColumnResizing:!0,footerRowHeight:65,multiSelect:!1,plugins:[n,o],onRegisterApi:function(r){l.gridApi=r,l.gridOptions.plugins.forEach(function(e){e.init(l,r.grid,null)}),r.selection.on.rowSelectionChanged(l,function(o){var e=l.reportSchema.drilldown;e&&(e=t.buildUrl(e.replace(/\|.+?\|/g,function(e){var r=e.slice(1,-1),t=/\((.+)\)/.exec(r);if(!t)return o.entity[r];var n=l.reportSchema.params[t[1]];return n?(l.param=l.record[t[1]],n.conversionExpression?l.$eval(n.conversionExpression):void 0):l.reportSchema.params[t[1]].value})),window.location=e)})}},l.report=[],!l.reportSchemaName&&c.$$search.r)switch(c.$$search.r.slice(0,1)){case"[":l.reportSchema.pipeline=JSON.parse(c.$$search.r);break;case"{":angular.extend(l.reportSchema,JSON.parse(c.$$search.r));break;default:throw new Error("No report instructions specified")}l.getTotalVal=function(r,e){var t="",n=_.find(l.reportSchema.columnDefs,function(e){return e.field===r});if(n)switch(n.totalsRow){case void 0:break;case"$SUM":for(var o=0,a=0;a<l.report.length;a++)o+=l.report[a][r];t=o,e&&(t=i(e)(t));break;default:t=n.totalsRow}return t},l.$on("exportToPDF",function(){n.createPDF()}),l.$on("exportToCSV",function(){o.createCSV()});var u=document.querySelector("div.report-grow");if(u){var d=u.offsetLeft,f=u.offsetTop+d,h=document.querySelector("div.ui-grid-header"),m=h?h.clientHeight:31,g=Math.floor((r.innerHeight-f-m-d)/30);angular.element(u).css("height",30*g+"px")}var v=e.navScope;v.items=[{fn:n.createPDF,text:"Save as PDF"},{fn:o.createCSV,text:"Export as CSV"}],v.contextMenu="Report",l.inhibitRefresh||(l.refreshQuery=function(){var e="/api/report/"+l.modelName,r="?";if(l.reportSchemaName)e+="/"+l.reportSchemaName;else{var t=c.$$url.match(/\?.*/);t&&(e+=r+t[0].slice(1),r="&")}if(l.paramSchema)for(var n in l.record)if(l.record.hasOwnProperty(n)){var o=l.reportSchema.params[n];if(l.record[n]&&""!==l.record[n])l.param=l.record[n],o.conversionExpression&&(l.param=l.$eval(o.conversionExpression)),e+=r+n+"="+l.param,r="&";else if(o.required)return}return a.get(e).then(function(e){var r=e.data;if(r.success){if(l.report=r.report,l.reportSchema=r.schema,l.reportSchema.title=l.reportSchema.title||l.modelName,l.reportSchema.title=l.reportSchema.title.replace(/\|.+?\|/g,function(e){var r=e.slice(1,-1),t=/\((.+)\)/.exec(r);return t?l.reportSchema.params[t[1]].value:""}),l.gridOptions.enableFiltering=!!l.reportSchema.filter,v&&v.items&&(v.items.length=2,l.reportSchema.menu&&(v.items=v.items.concat(l.reportSchema.menu))),p&&(p=!1,l.$watch("reportSchema.columnDefs",function(e){var r=!1;if(e){for(var t=0;t<e.length;t++)if(e[t].totalsRow&&(r=!0),e[t].align){var n="fng-"+e[t].align;e[t].cellClass=e[t].cellClass||"",-1===e[t].cellClass.indexOf(n)&&(e[t].cellClass=e[t].cellClass+" "+n)}e.forEach(function(e){e.width&&"string"==typeof e.width&&-1!==e.width.indexOf("px")&&(e.width=parseInt(e.width.slice(0,-2)))}),l.gridOptions.columnDefs=e}l.gridOptions.showTotals=r,l.gridOptions.reallyShowFooter=r,l.gridOptions.footerRowHeight=55+(r?10:0)},!0),!l.paramSchema&&r.schema.params)){for(var t in l.paramSchema=[],l.record={},r.schema.params)if(r.schema.params.hasOwnProperty(t)){var n=r.schema.params[t];if(!n.noInput){var o=l.paramSchema.push({name:t,id:"fp_"+t,label:n.label||i("titleCase")(t),type:n.type||"text",required:!0,add:n.add||void 0,size:n.size||("bs3"===s.frameWork?"large":"medium")});"select"===n.type&&(l[t+"_Opts"]=n.enum,l.paramSchema[o-1].options=t+"_Opts")}var a=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(n.value);a&&(n.value=new Date(a[1])),l.record[t]=n.value}l.$watch("record",function(e,r){r!==e&&l.refreshQuery()},!0)}}else console.log(JSON.stringify(r)),l.reportSchema.title="Error - see console log"},function(e){console.log(JSON.stringify(e)),c.path("/404")})},l.refreshQuery()),l.$on("$locationChangeStart",function(){delete v.contextMenu,delete v.items})}]);var COL_FIELD=/COL_FIELD/g;function ngGridCsvExportPlugin(o){var a=this;a.grid=null,a.scope=null,a.services=null,a.init=function(t,e,r){function n(){var e=angular.element("h1").parent(),r=angular.element("#csv-data-link");null!=r&&r.remove();var t='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';t+=encodeURIComponent(a.prepareCSV()),t+='" download="Export.csv">CSV Export</button>',e.append(t)}a.grid=e,a.scope=t,a.services=r,o.inhibitButton||(setTimeout(n,0),t.catHashKeys=function(){var e="";for(var r in t.renderedRows)e+=t.renderedRows[r].$$hashKey;return e},t.$watch("catHashKeys()",n))},a.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(a.prepareCSV()))},a.prepareCSV=function(){function t(e){return null==e?"":"number"==typeof e?""+e:"boolean"==typeof e?e?"TRUE":"FALSE":"string"==typeof e?e.replace(/"/g,'""'):JSON.stringify(e).replace(/"/g,'""')}function e(e){return e.substr(0,e.length-1)+"\n"}var n="";return angular.forEach(a.grid.columns,function(e){e.visible&&(void 0===e.width||"*"===e.width||0<e.width)&&(n+='"'+t(e.displayName)+'",')}),n=e(n),angular.forEach(a.grid.rows,function(r){r.visible&&(angular.forEach(a.grid.columns,function(e){e.visible&&(n+='"'+t(r.entity[e.field])+'",')}),n=e(n))}),n}}function ngGridPdfExportPlugin(a){var i=this;i.grid=null,i.scope=null,i.services=null,i.options=a,i.init=function(e,r,t){if(i.grid=r,i.scope=e,i.services=t,!a.inhibitButton){var n=r.$root.find(".ngFooterPanel"),o=r.$root.find(".ngFooterPanel .pdf-data-link-span");null!=o&&o.remove();n.append('<button class="pdf-data-link-span">PDF Export</button>'),n.on("click",function(){i.createPDF()})}},i.createPDF=function(){var r=[],n=[],t=[],e=[];angular.forEach(i.grid.columns,function(e){e.visible&&(r.push(e.displayName),n.push(e.field)),e.colDef.totalsRow&&(t[e.field]=i.grid.getTotalVal(e.field,e.filter).toString())}),angular.forEach(i.grid.rows,function(r){var t=[];r.visible&&(n.forEach(function(e){t.push(r.entity[e])}),e.push(t))});var o=new jsPDF("landscape","mm","a4");o.autoTable({head:[r],body:e}),window.open(o.output("bloburl"))}}formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(i,t){return{scope:!1,compile:function(){return{pre:function(e,r){var t,n,o=e.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);n=o?e.col.cellTemplate.replace("COL_FIELD |"+o[1],'getTotalVal("'+e.col.field+'","'+o[1]+'")'):e.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+e.col.field+'")'),t=e.col.enableCellEdit?(t=(t=e.col.cellEditTemplate).replace(DISPLAY_CELL_TEMPLATE,n)).replace(EDITABLE_CELL_TEMPLATE,e.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+e.col.field)):n;var a=i(t)(e);e.enableCellSelection&&-1===a[0].className.indexOf("ngSelectionCell")&&(a[0].setAttribute("tabindex",0),a.addClass("ngCellElement")),r.append(a)},post:function(e,r){e.enableCellSelection&&e.domAccessProvider.selectionHandlers(e,r),e.$on("ngGridEventDigestCell",function(){t.digest(e)})}}}}}]);