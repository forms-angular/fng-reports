/*! forms-angular 2020-05-25 */

"use strict";formsAngular.controller("AnalysisCtrl",["$rootScope","$window","$filter","$scope","$http","$location","cssFrameworkService","routingService",function(e,t,o,l,i,s,c,r){var g=!0,n=new ngGridPdfExportPlugin({inhibitButton:!0}),a=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(l,r.parsePathFunc()(s.$$path)),l.reportSchema={columnDefs:[]},l.gridOptions={data:"report",columnDefs:l.reportSchema.columnDefs,showColumnMenu:!0,enableRowHeaderSelection:!1,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResizing:!0,footerRowHeight:65,multiSelect:!1,plugins:[n,a],onRegisterApi:function(t){l.gridApi=t,l.gridOptions.plugins.forEach(function(e){e.init(l,t.grid,null)}),t.selection.on.rowSelectionChanged(l,function(a){var e=l.reportSchema.drilldown;e&&(e=r.buildUrl(e.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),r=/\((.+)\)/.exec(t);if(!r)return a.entity[t];var n=l.reportSchema.params[r[1]];return n?(l.param=l.record[r[1]],n.conversionExpression?l.$eval(n.conversionExpression):void 0):l.reportSchema.params[r[1]].value})),window.location=e)})},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},l.report=[],!l.reportSchemaName&&s.$$search.r)switch(s.$$search.r.slice(0,1)){case"[":l.reportSchema.pipeline=JSON.parse(s.$$search.r);break;case"{":angular.extend(l.reportSchema,JSON.parse(s.$$search.r));break;default:throw new Error("No report instructions specified")}l.getTotalVal=function(t,e){var r="",n=_.find(l.reportSchema.columnDefs,function(e){return e.field===t});if(n)switch(n.totalsRow){case void 0:break;case"$SUM":for(var a=0,i=0;i<l.report.length;i++)a+=l.report[i][t];r=a,e&&(r=o(e)(r));break;default:r=n.totalsRow}return r},l.$on("exportToPDF",function(){n.createPDF()}),l.$on("exportToCSV",function(){a.createCSV()});var p=document.querySelector("div.report-grow");if(p){var d=p.offsetLeft,u=p.offsetTop+d,h=document.querySelector("div.ui-grid-header"),f=h?h.clientHeight:31,m=Math.floor((t.innerHeight-u-f-d)/30);angular.element(p).css("height",30*m+"px")}l.inhibitRefresh||(l.refreshQuery=function(){var e="/api/report/"+l.modelName,t="?";if(l.reportSchemaName&&(e+="/"+l.reportSchemaName),l.paramSchema){for(var r in l.record)if(l.record.hasOwnProperty(r)){var n=l.reportSchema.params[r];if(l.record[r]&&""!==l.record[r])l.param=l.record[r],n.conversionExpression&&(l.param=l.$eval(n.conversionExpression)),e+=t+r+"="+l.param,t="&";else if(n.required)return}}else{var a=s.$$url.match(/\?.*/);a&&(e+=t+a[0].slice(1))}return i.get(e).then(function(e){var t=e.data;if(t.success){if(l.report=t.report,l.reportSchema=t.schema,l.reportSchema.title=l.reportSchema.title||l.modelName,l.reportSchema.title=l.reportSchema.title.replace(/\|.+?\|/g,function(e){var t=e.slice(1,-1),r=/\((.+)\)/.exec(t);return r?l.reportSchema.params[r[1]].value:""}),g&&(g=!1,l.$watch("reportSchema.columnDefs",function(e){var t=!1;if(e){for(var r=0;r<e.length;r++)if(e[r].totalsRow&&(t=!0),e[r].align){var n="fng-"+e[r].align;e[r].cellClass=e[r].cellClass||"",-1===e[r].cellClass.indexOf(n)&&(e[r].cellClass=e[r].cellClass+" "+n)}e.forEach(function(e){e.width&&"string"==typeof e.width&&-1!==e.width.indexOf("px")&&(e.width=parseInt(e.width.slice(0,-2)))}),l.gridOptions.columnDefs=e}l.gridOptions.showTotals=t,l.gridOptions.reallyShowFooter=t,l.gridOptions.footerRowHeight=55+(t?10:0)},!0),!l.paramSchema&&t.schema.params)){for(var r in l.paramSchema=[],l.record={},t.schema.params)if(t.schema.params.hasOwnProperty(r)){var n=t.schema.params[r];if(!n.noInput){var a=l.paramSchema.push({name:r,id:"fp_"+r,label:n.label||o("titleCase")(r),type:n.type||"text",required:!0,add:n.add||void 0,size:n.size||("bs3"===c.frameWork?"large":"medium")});"select"===n.type&&(l[r+"_Opts"]=n.enum,l.paramSchema[a-1].options=r+"_Opts")}var i=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(n.value);i&&(n.value=new Date(i[1])),l.record[r]=n.value}l.$watch("record",function(e,t){t!==e&&l.refreshQuery()},!0)}}else console.log(JSON.stringify(t)),l.reportSchema.title="Error - see console log"},function(e){console.log(JSON.stringify(e)),s.path("/404")})},l.refreshQuery());var v=e.navScope;v.items=[{fn:n.createPDF,text:"Save as PDF"},{fn:a.createCSV,text:"Export as CSV"}],v.contextMenu="Report"}]);var COL_FIELD=/COL_FIELD/g;function ngGridCsvExportPlugin(a){var i=this;i.grid=null,i.scope=null,i.services=null,i.init=function(r,e,t){function n(){var e=angular.element("h1").parent(),t=angular.element("#csv-data-link");null!=t&&t.remove();var r='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';r+=encodeURIComponent(i.prepareCSV()),r+='" download="Export.csv">CSV Export</button>',e.append(r)}i.grid=e,i.scope=r,i.services=t,a.inhibitButton||(setTimeout(n,0),r.catHashKeys=function(){var e="";for(var t in r.renderedRows)e+=r.renderedRows[t].$$hashKey;return e},r.$watch("catHashKeys()",n))},i.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(i.prepareCSV()))},i.prepareCSV=function(){function r(e){return null==e?"":"number"==typeof e?""+e:"boolean"==typeof e?e?"TRUE":"FALSE":"string"==typeof e?e.replace(/"/g,'""'):JSON.stringify(e).replace(/"/g,'""')}function e(e){return e.substr(0,e.length-1)+"\n"}var n="";return angular.forEach(i.grid.columns,function(e){e.visible&&(void 0===e.width||"*"===e.width||0<e.width)&&(n+='"'+r(e.displayName)+'",')}),n=e(n),angular.forEach(i.grid.rows,function(t){t.visible&&(angular.forEach(i.grid.columns,function(e){e.visible&&(n+='"'+r(t.entity[e.field])+'",')}),n=e(n))}),n}}function ngGridPdfExportPlugin(i){var o=this;o.grid=null,o.scope=null,o.services=null,o.options=i,o.init=function(e,t,r){if(o.grid=t,o.scope=e,o.services=r,!i.inhibitButton){var n=t.$root.find(".ngFooterPanel"),a=t.$root.find(".ngFooterPanel .pdf-data-link-span");null!=a&&a.remove();n.append('<button class="pdf-data-link-span">PDF Export</button>'),n.on("click",function(){o.createPDF()})}},o.createPDF=function(){var t=[],n=[],r=[],e=[];angular.forEach(o.grid.columns,function(e){e.visible&&(t.push(e.displayName),n.push(e.field)),e.colDef.totalsRow&&(r[e.field]=o.grid.getTotalVal(e.field,e.filter).toString())}),angular.forEach(o.grid.rows,function(t){var r=[];t.visible&&(n.forEach(function(e){r.push(t.entity[e])}),e.push(r))});var a=new jsPDF("landscape","mm","a4");a.autoTable({head:[t],body:e}),window.open(a.output("bloburl"))}}formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(o,r){return{scope:!1,compile:function(){return{pre:function(e,t){var r,n,a=e.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);n=a?e.col.cellTemplate.replace("COL_FIELD |"+a[1],'getTotalVal("'+e.col.field+'","'+a[1]+'")'):e.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+e.col.field+'")'),r=e.col.enableCellEdit?(r=(r=e.col.cellEditTemplate).replace(DISPLAY_CELL_TEMPLATE,n)).replace(EDITABLE_CELL_TEMPLATE,e.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+e.col.field)):n;var i=o(r)(e);e.enableCellSelection&&-1===i[0].className.indexOf("ngSelectionCell")&&(i[0].setAttribute("tabindex",0),i.addClass("ngCellElement")),t.append(i)},post:function(e,t){e.enableCellSelection&&e.domAccessProvider.selectionHandlers(e,t),e.$on("ngGridEventDigestCell",function(){r.digest(e)})}}}}}]);